<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediSight - AI Medical Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
</head>
<body>
    <!-- Medical Disclaimer Modal -->
    <div class="disclaimer-overlay" id="disclaimerOverlay">
        <div class="disclaimer-modal">
            <div class="disclaimer-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="disclaimer-title">Important Medical Disclaimer</h2>
            <div class="disclaimer-text">
                <p><strong>Please read carefully before proceeding:</strong></p>
                <ul>
                    <li><strong>AI Assistant:</strong> MediSight is an artificial intelligence chatbot designed to provide general health information only.</li>
                    <li><strong>Not Medical Advice:</strong> The information provided is not intended to replace professional medical advice, diagnosis, or treatment.</li>
                    <li><strong>Consult Healthcare Professionals:</strong> Always seek the advice of qualified healthcare providers with any questions about medical conditions.</li>
                    <li><strong>Emergency Situations:</strong> In case of medical emergencies, contact emergency services immediately.</li>
                    <li><strong>No Liability:</strong> Use this tool at your own discretion and risk.</li>
                </ul>
                <p>By continuing, you acknowledge that you understand these limitations and agree to use MediSight responsibly.</p>
            </div>
            <div class="disclaimer-buttons">
                <button class="disclaimer-btn secondary" onclick="closeApp()">I Disagree</button>
                <button class="disclaimer-btn primary" onclick="acceptDisclaimer()">I Understand & Agree</button>
            </div>
        </div>
    </div>
    <div class="app-container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-stethoscope"></i>
                <div>
                    <h1>MediSight</h1>
                    <div class="header-subtitle">AI Medical Assistant</div>
                </div>
            </div>
            <div class="nav-links">
                <a href="/about"><i class="fas fa-info-circle"></i> About</a>
                <a href="/articles"><i class="fas fa-newspaper"></i> Articles</a>
            </div>
        </div>

        <div class="chat-container">
            <div class="messages-area" id="messages-area">
                <div class="welcome-message">
                    <i class="fas fa-user-md"></i>
                    <h2>Welcome to MediSight</h2>
                    <p>I'm your AI medical assistant. Ask me about symptoms, conditions, medications, or upload a medical report for analysis. How can I help you today?</p>
                </div>
            </div>

            <div class="typing-indicator" id="typing-indicator">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <div class="input-area">
                <form id="chat-form" enctype="multipart/form-data">

                    <div class="file-upload-section">
                        <label for="report" class="file-upload-label">
                            <i class="fas fa-file-medical"></i>
                            <span>Click to upload medical report (PDF)</span>
                        </label>
                        <input type="file" id="report" name="report" accept=".pdf">
                        <div class="file-selected" id="file-selected"></div>
                        <div class="report-status" id="report-status">
                            <i class="fas fa-check-circle"></i>
                            <span id="report-status-text">Report uploaded and available for this conversation</span>
                            <button type="button" class="clear-report" onclick="clearReport()">Clear</button>
                        </div>
                    </div>

                    <div class="input-container">
                        <textarea 
                            id="user_query" 
                            name="user_query" 
                            placeholder="Ask me about your health concerns, symptoms, or medical questions..."
                            required
                            rows="1"
                        ></textarea>
                        <button type="submit" class="send-button" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const messagesArea = document.getElementById('messages-area');
        const userQueryInput = document.getElementById('user_query');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const fileInput = document.getElementById('report');
        const fileSelected = document.getElementById('file-selected');
        const reportStatus = document.getElementById('report-status');
        let reportUploaded = false;

        userQueryInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileSelected.textContent = `Selected: ${this.files[0].name}`;
                fileSelected.style.display = 'block';
            } else {
                fileSelected.style.display = 'none';
            }
        });

        chatForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(chatForm);
            const userQuery = formData.get('user_query').trim();
            
            if (!userQuery) return;
            
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
            
            addMessage(userQuery, 'user');
            userQueryInput.value = '';
            userQueryInput.style.height = 'auto';
            showTypingIndicator();
            sendButton.disabled = true;

            try {
                // Only include file if not already uploaded
                const requestFormData = new FormData();
                requestFormData.append('user_query', userQuery);
                
                if (fileInput.files.length > 0 && !reportUploaded) {
                    requestFormData.append('report', fileInput.files[0]);
                }

                const response = await fetch('/chat', {
                    method: 'POST',
                    body: requestFormData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                hideTypingIndicator();
                
                if (result.error) {
                    addMessage(`Error: ${result.error}`, 'ai');
                } else if (result.answer) {
                    addMessage(result.answer, 'ai');
                    
                    // Show report status if a file was uploaded
                    if (fileInput.files.length > 0 && !reportUploaded) {
                        reportStatus.style.display = 'block';
                        fileSelected.style.display = 'none';
                        reportUploaded = true;
                        
                        // Update status text to show conversation continuity
                        document.getElementById('report-status-text').textContent = 
                            `Report uploaded and available for this conversation`;
                    }
                    
                    // Add a small indicator that conversation is being maintained
                    if (reportUploaded) {
                        console.log('Report context maintained for question:', userQuery);
                    }
                } else {
                    addMessage('I received an empty response. Please try again.', 'ai');
                }

            } catch (error) {
                hideTypingIndicator();
                addMessage('Sorry, I encountered an error while processing your request. Please try again.', 'ai');
            } finally {
                sendButton.disabled = false;
                // Clear file input only if upload was successful or no file was selected
                if (reportUploaded || fileInput.files.length === 0) {
                    fileInput.value = '';
                    fileSelected.style.display = 'none';
                }
            }
        });

        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (sender === 'ai') {
                try {
                    if (typeof marked !== 'undefined' && marked.parse) {
                        messageContent.innerHTML = marked.parse(content);
                    } else if (typeof marked !== 'undefined' && marked) {
                        messageContent.innerHTML = marked(content);
                    } else {
                        let formatted = content
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')
                            .replace(/`(.*?)`/g, '<code>$1</code>')
                            .replace(/\n\n/g, '</p><p>')
                            .replace(/\n/g, '<br>');
                        messageContent.innerHTML = '<p>' + formatted + '</p>';
                    }
                } catch (error) {
                    let formatted = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/`(.*?)`/g, '<code>$1</code>')
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/\n/g, '<br>');
                    messageContent.innerHTML = '<p>' + formatted + '</p>';
                }
            } else {
                messageContent.textContent = content;
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);

            messagesArea.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            typingIndicator.style.display = 'flex';
            scrollToBottom();
        }

        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }

        function scrollToBottom() {
            setTimeout(() => {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100);
        }

        userQueryInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        });

        window.addEventListener('load', function() {
            // Show disclaimer on page load
            showDisclaimer();
            
            // Check if there's already a report in session
            checkSessionStatus();
        });

        async function checkSessionStatus() {
            try {
                const response = await fetch('/session_status');
                const status = await response.json();
                
                console.log('Session status:', status);
                
                if (status.has_report && status.report_filename) {
                    reportStatus.style.display = 'block';
                    document.getElementById('report-status-text').textContent = 
                        `Report "${status.report_filename}" available for this conversation`;
                    reportUploaded = true;
                }
            } catch (error) {
                console.log('Could not check session status:', error);
            }
        }

        async function clearReport() {
            try {
                const response = await fetch('/clear_session', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    reportStatus.style.display = 'none';
                    reportUploaded = false;
                    fileInput.value = '';
                    fileSelected.style.display = 'none';
                    addMessage('✓ Medical report has been cleared from this conversation.', 'ai');
                }
            } catch (error) {
                console.error('Error clearing report:', error);
            }
        }

        // Disclaimer functions
        function showDisclaimer() {
            const disclaimerOverlay = document.getElementById('disclaimerOverlay');
            disclaimerOverlay.style.display = 'flex';
        }

        function acceptDisclaimer() {
            const disclaimerOverlay = document.getElementById('disclaimerOverlay');
            disclaimerOverlay.style.display = 'none';
            userQueryInput.focus();
            
            // Store acceptance in sessionStorage so it doesn't show again in same session
            sessionStorage.setItem('disclaimerAccepted', 'true');
        }

        function closeApp() {
            alert('Thank you for your understanding. Please consult with healthcare professionals for medical advice.');
            window.close();
            // If window.close() doesn't work (some browsers block it), redirect away
            setTimeout(() => {
                window.location.href = 'about:blank';
            }, 1000);
        }

        // Check if disclaimer was already accepted in this session
        window.addEventListener('load', function() {
            const disclaimerAccepted = sessionStorage.getItem('disclaimerAccepted');
            if (disclaimerAccepted === 'true') {
                document.getElementById('disclaimerOverlay').style.display = 'none';
            } else {
                showDisclaimer();
            }
            
            if (document.getElementById('disclaimerOverlay').style.display === 'none') {
                userQueryInput.focus();
            }
        });
    </script>
</body>
</html>